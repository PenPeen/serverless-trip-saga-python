# Testing Guidelines

## 1. 概要

本ドキュメントでは、プロジェクトにおけるテストコードの記述ルールと、DDDの各構成要素に対するテスト方針を定義します。

## 2. テスト基本方針

### 2.1 構成

- 基本はクラスでグルーピング

### 2.2 AAAパターン

- Arrange / Act / Assert をコメントで明示

### 2.3 fixture

- テストの準備処理は `@pytest.fixture` で共通化
- 共通fixtureは `conftest.py` に配置

### 2.4 例

```python
@pytest.fixture
def user():
    return User.create(email="test@example.com")

def test_user_can_change_email(user):
    # Arrange
    new_email = "new@example.com"

    # Act
    user.change_email(new_email)

    # Assert
    assert user.email == new_email
```

## 3. DDDレイヤー別テスト方針

### 3.1 Entity（Aggregate）

#### 同一性の検証

> **Note:** Entity基底クラスがある場合は基底クラスでテストを実施

- 同じIDを持つエンティティが等価と判定されること
- 異なるIDを持つエンティティが非等価と判定されること

#### 振る舞いの検証

- ドメインロジックを含むメソッドが正しく動作すること
- メソッド実行後の状態が期待通りになること
- ドメインイベントが適切に発行されること（イベント駆動の場合）

### 3.2 ValueObject

#### 等価性の検証

> **Note:** `@dataclass(frozen=True)` を使用している場合、等価性（`__eq__`、`__hash__`）はPython言語レベルで保証されるため、個別のValueObjectでの等価性テストは**省略可能**。

#### 不変性の検証

> **Note:** `frozen=True` を使用している場合は不要

- 生成後に値が変更できないこと
- すべての属性がfinalまたは不変であること

#### バリデーションの検証

- 不正な値での生成が例外をスローすること
- 境界値のテスト（最小値、最大値、空文字列など）
- フォーマット検証（メールアドレス、電話番号など）

#### 振る舞いの検証

- 計算ロジックや変換メソッドが正しく動作すること

### 3.3 Repository

#### 基本的なCRUD操作

- 保存（save/add）が正しく動作すること
- IDによる取得（findById）が正しく動作すること
- 存在しないIDでの取得時の振る舞い（null返却または例外）
- 更新（update）が正しく反映されること
- 削除（delete）が正しく動作すること

#### クエリメソッドの検証

- 検索条件に合致するエンティティが取得できること
- 検索結果が期待通りの順序で返されること
- 該当データがない場合の振る舞い

#### 集約の整合性

- 集約全体が正しく保存・取得されること
- 子エンティティも含めて永続化されること

### 3.4 Factory

#### 正常系の生成

- 必要なパラメータから正しくオブジェクトが生成されること
- デフォルト値が適切に設定されること
- 複雑な初期化ロジックが正しく実行されること

#### 異常系の検証

- 不正なパラメータで生成が失敗すること
- 必須パラメータの欠如が検知されること
- ビジネスルールに違反する組み合わせが拒否されること

#### ドメインオブジェクトへの変換

- 永続化されたデータから正しくオブジェクトが再構築されること
- すべての属性が正しく復元されること
